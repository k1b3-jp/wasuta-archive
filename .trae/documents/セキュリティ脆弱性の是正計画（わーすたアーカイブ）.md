## 方針
イベントや動画管理の権限は「所有者」ではなく、特定の管理者ユーザー（サイト運営者）のみが持つ前提に統一します。一般ユーザー（認証済みでも）は作成・更新・削除を不可とし、参照のみ可能とします。

## 現状確認（抜粋）
- クライアント管理者判定: `src/contexts/AuthContext.tsx:35`（公開環境変数で管理者メール比較）
- クライアントから直接DB操作・認可なし: 
  - イベント: `src/lib/supabase/createEvent.ts:16-27`, `updateEvent.ts:20-29`, `deleteEvent.ts:90-95`
  - YouTube: `createYoutubeLink.ts:53-57`, `deleteYoutubeLink.ts:8-17, 20-37`
- ストレージ削除が認可なし: `src/lib/supabase/deleteStorage.ts:3-8`（`[id]/edit.tsx:170-173` 経由）
- 格納型XSSのリスク: `src/pages/events/[id].tsx:254` で `html-react-parser` によるHTML挿入
- RLS/Storageポリシーが過度に緩い: `supabase/migrations/20240210053552_remote_schema.sql` / `20240221095107_remote_schema.sql`

## 対策概要
1. 管理者ロールの厳格な定義（DBで集中管理）
2. すべての作成・更新・削除操作を「管理者のみ」許可するRLSへ変更
3. クライアントの直接操作を廃止し、サーバーAPIで管理者認可と入力検証を実施
4. XSSとCSPの強化
5. アップロードのサーバー制御（サイズ・レート・クォータ・クリーンアップ）

## 実装ステップ
### 1. 管理者ロールの導入
- `public.user_roles (user_id uuid primary key, role text)` を追加し、`role='admin'` のみを運用
- `is_admin(u uuid)` 関数（SQL STABLE）でロール判定
- 管理者ユーザー（サイト運営者）を登録
- 備考: `app_metadata.roles` を使う選択肢もあるが、RLSから参照しやすいテーブル運用を推奨

### 2. RLS/Storageポリシーの再設計（管理者のみ許可）
- `events` / `event_tags` / `event_youtube_links` / `youtube_links` / `youtube_tags`
  - select: 公開（必要に応じて制限）
  - insert/update/delete: `using (is_admin(auth.uid())) with check (is_admin(auth.uid()))`
- `storage.objects`（`event_pics` バケット）
  - select: 公開URLのみ（または公開可）
  - insert/update/delete: `bucket_id='event_pics' and is_admin(auth.uid())`
- 既存の緩い `using(true)` / `with check(true)` を全廃

### 3. サーバーAPIの追加（管理者のみ実行可能）
- エンドポイント（例）
  - `src/pages/api/events/create.ts | update.ts | delete.ts`
  - `src/pages/api/youtube/create.ts | delete.ts`
  - `src/pages/api/storage/upload.ts | delete.ts`
- 共通処理
  - セッション検証 → 管理者判定（`is_admin`）
  - 入力バリデーション（URL/MIME/サイズ/必須項目）
  - DBとストレージの整合性保持（失敗時のロールバック）
  - ログ記録（監査）
- サービスロールキー（`SUPABASE_SERVICE_ROLE_KEY`）は必要最小限。原則は厳格RLS内で完結

### 4. クライアントコード修正
- 管理者判定の撤廃・秘匿化
  - `src/contexts/AuthContext.tsx:35` の `NEXT_PUBLIC_ADMIN_USER_EMAIL` を削除
  - UI上の管理ボタンは「サーバーAPIから返る権限フラグ」で表示制御
- 直接DB操作をAPI呼び出しへ置換
  - `createEvent/updateEvent/deleteEvent/createYoutubeLink/deleteYoutubeLink/deleteStorage/uploadStorage` の利用箇所を全てAPI経由へ
- 表示ロジック
  - 一般ユーザー: 閲覧のみ
  - 管理者: 編集/削除/登録ボタン表示

### 5. XSS対策
- `src/pages/events/[id].tsx:254` を修正
  - `DOMPurify` でサニタイズし、許可タグを最小限（`a`, `br`）・許可属性限定（`href`, `rel`, `target`, `class`）
  - `html-react-parser` の使用中止
- CSPの導入（`next.config.js` → `headers()`）
  - 例: `Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://*.supabase.co`
  - 将来的に `nonce` 化で `unsafe-inline` を撤廃

### 6. アップロード制御/クォータ/クリーンアップ
- サーバーAPI `storage/upload` にて強制
  - サーバーで1MiB上限、MIME検証、画像以外拒否
  - 管理者のみアップロード可能（一般ユーザーは不可）
  - アップロード回数・総容量のレート制限（`upload_limits` テーブル）
- 失敗時に即ロールバック（孤立ファイルを削除）
- 定期メンテAPI（管理者のみ）で孤立オブジェクト掃除

### 7. マイグレーション/移行
- 追加DDL（例）
  - `create table public.user_roles (user_id uuid primary key, role text not null check (role='admin'));`
  - `create function public.is_admin(u uuid) returns boolean language sql stable as $$ select exists(select 1 from public.user_roles r where r.user_id = u and r.role='admin') $$;`
- RLS差し替え
  - 全テーブル/ストレージの `insert/update/delete` を `is_admin(auth.uid())` に限定
- 管理者ユーザー登録（サイト運営者を反映）

### 8. テスト/検証
- 一般ユーザーの作成/更新/削除が全て拒否されることを確認
- 管理者のみ操作が成功することを確認
- XSSサニタイズの有効性（代表的ペイロードで検証）
- ストレージ削除が管理者以外で拒否されることを確認
- アップロードのレート制限/クォータの動作確認

## ロールアウト順
1. DBに管理者ロール導入→RLS/Storageポリシー厳格化
2. サーバーAPI導入→クライアントの操作導線をAPIへ切替
3. XSS対策・CSP適用
4. アップロード制御適用
5. 最終確認後に公開環境変数による管理者判定を撤廃

管理者専用運用の前提に合わせて対策を再設計しました。了承いただければ、この計画に沿って実装へ進みます。